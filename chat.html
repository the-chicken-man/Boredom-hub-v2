<script>
    document.getElementById("messageInput").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Prevent default newline behavior
            sendMessage();
        }
    });

    const ably = new Ably.Realtime("mGqA8g.tKm8cg:BXet5NQMtxfr8k8I4Ls0MEzeQxmsQHihc80xDsYd-Ko");
    const channel = ably.channels.get("chat-room");

    let mutedUsers = {}; // Stores globally muted users
    const modEmails = [ "878197@dpsk12.net", "871341@dpsk12.net"]; // Mods
    const devEmails = ["856030@dpsk12.net", "866537@dpsk12.net", "871491@dpsk12.net","872654@dpsk12.net"]; // Devs

    function signIn() {
        const email = prompt("Enter your email:");
        const username = prompt("Enter your username:");

        if (!email || !username) {
            alert("Email and username are required!");
            return;
        }

        sessionStorage.setItem("userEmail", email);
        sessionStorage.setItem("username", username);
        document.getElementById("authStatus").innerText = `Logged in as ${email}`;
    }

    function signOut() {
        sessionStorage.removeItem("userEmail");
        sessionStorage.removeItem("username");
        document.getElementById("authStatus").innerText = "Not logged in";
    }

    function sendMessage() {
        const messageInput = document.getElementById("messageInput").value.trim();
        const email = sessionStorage.getItem("userEmail");
        const username = sessionStorage.getItem("username");

        if (!email || !username) {
            alert("You must be signed in to send messages.");
            return;
        }

        // **Check if user is muted before sending**
        if (mutedUsers[email]) {
            alert("You are muted and cannot send messages.");
            return;
        }

        // **Handle mute/unmute commands**
        if (messageInput.startsWith("/mute")) {
            handleMuteCommand(messageInput);
            return;
        }
        if (messageInput.startsWith("/unmute")) {
            handleUnmuteCommand(messageInput);
            return;
        }

        // **Send message**
        channel.publish("message", { text: messageInput, user: email, username: username });
        document.getElementById("messageInput").value = "";
    }
</script>
